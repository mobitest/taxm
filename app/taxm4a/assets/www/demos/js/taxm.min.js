var SERVICE_PATH="http://192.168.137.1:8080/core/services/api/";var FILE_PATH="../data/";var DROP_TABLE=false;var DEBUG_LOCAL=false;var update_time=(new Date).toISOString();dbutil={db:null,dbSize:5*1024*1024,init:function(){this.db=openDatabase("taxm","1.0","taxm manager",this.dbSize);return this},createTable:function(){this.db.transaction(function(e){if(DROP_TABLE){e.executeSql("drop table if exists corp_jbxx",[]);e.executeSql("drop table if exists corp_hd",[]);e.executeSql("drop table if exists corp_ns",[]);e.executeSql("drop table if exists corp_sb",[]);e.executeSql("drop table if exists corp_fpgz",[]);e.executeSql("drop table if exists corp_sbfjf",[])}e.executeSql("CREATE TABLE IF NOT EXISTS corp_jbxx(ID INTEGER PRIMARY KEY ASC, name text unique, content TEXT, update_time DATETIME)",[],dbutil.onSuccess);e.executeSql("CREATE TABLE IF NOT EXISTS corp_hd(ID INTEGER PRIMARY KEY ASC, name text unique, content TEXT, update_time DATETIME)",[],dbutil.onSuccess);e.executeSql("CREATE TABLE IF NOT EXISTS corp_ns(ID INTEGER PRIMARY KEY ASC, name text unique, content TEXT, update_time DATETIME)",[],dbutil.onSuccess);e.executeSql("CREATE TABLE IF NOT EXISTS corp_sb(ID INTEGER PRIMARY KEY ASC, name text unique, content TEXT, update_time DATETIME)",[],dbutil.onSuccess);e.executeSql("CREATE TABLE IF NOT EXISTS corp_fpgz(ID INTEGER PRIMARY KEY ASC, name text unique, content TEXT, update_time DATETIME)",[],dbutil.onSuccess);e.executeSql("CREATE TABLE IF NOT EXISTS corp_sbfjf(ID INTEGER PRIMARY KEY ASC, name text unique, content TEXT, update_time DATETIME)",[],dbutil.onSuccess)})},writeRow:function(e,t,n){var r=n?n:dbutil.onSuccess;this.db.transaction(function(r){r.executeSql("replace into "+e+"(name, content, update_time) values(?, ?,?)",[t.name,t.content,(new Date).toISOString()],n,dbutil.onError)})},cleanCache:function(){console.log("now clear the cache rows over 50");this.db.transaction(function(e){console.log("clear jbxx");e.executeSql("delete from corp_jbxx where id not in(select id from corp_jbxx b order by update_time desc limit 50) ",[],dbutil.onSuccess,dbutil.onError);console.log("clear corp_hd");e.executeSql("delete from corp_hd where name not in(select name as nsrbm from corp_jbxx b order by update_time desc limit 50) ",[],dbutil.onSuccess,dbutil.onError);console.log("clear corp_ns");e.executeSql("delete from corp_ns where name not in(select name as nsrbm   from corp_jbxx b order by update_time desc limit 50) ",[],dbutil.onSuccess,dbutil.onError);console.log("clear corp_sb");e.executeSql("delete from corp_sb where name not in(select name as nsrbm   from corp_jbxx b order by update_time desc limit 50) ",[],dbutil.onSuccess,dbutil.onError);console.log("clear corp_fpgz");e.executeSql("delete from corp_fpgz where name not in(select name as nsrbm   from corp_jbxx b order by update_time desc limit 50) ",[],dbutil.onSuccess,dbutil.onError);console.log("clear corp_sbfjf");e.executeSql("delete from corp_sbfjf where name not in(select name as nsrbm   from corp_jbxx b order by update_time desc limit 50) ",[],dbutil.onSuccess,dbutil.onError)})},onError:function(e,t){alert("websql error: "+t.message)},onSuccess:function(e,t){console.log("success ;rowcount:"+t.rows.length)},findByName:function(e,t,n){this.db.transaction(function(r){r.executeSql("select id,name,content,update_time from "+e+" where name like '%"+t+"%' order by update_time desc",[],n,dbutil.onError)})}};PageBuilder={load:function(e,t,n){var r=SERVICE_PATH+e+"/"+t+".json";if(DEBUG_LOCAL)r=FILE_PATH+e+".json";$.mobile.loadingMessage="数据获取中";$.mobile.showPageLoadingMsg();if(n)return PageBuilder.getRemote(e,t,r);dbutil.findByName("corp_"+e,t,function(n,i){if(i.rows.length==0||i.rows.item(0).content.length==0){PageBuilder.getRemote(e,t,r);return}update_time=i.rows.item(0).update_time;PageBuilder.render(e,JSON.parse(i.rows.item(0).content))})},getRemote:function(e,t,n){$.mobile.loadingMessage=e+" 远程数据获取中";$.mobile.showPageLoadingMsg();$(".ui-loader h1").text("my custom loading msg..");$.ajax({url:n,dataType:DEBUG_LOCAL?"json":"jsonp",success:function(n){if(n.length>0){var r=new Object;r.name=t;if(e=="jbxx"){r.name=n[0].nsrMc;n=n[0]}r.content=JSON.stringify(n);if(r.content.length>"[]".length){dbutil.writeRow("corp_"+e,r,function(e,n){console.log("write a row, name="+t)})}}PageBuilder.render(e,n)},error:function(e,t,n){$.mobile.hidePageLoadingMsg();alert("ajax get error:\r\nerrorThrown="+n+" \r\nresponseText="+e.responseText+" \r\ntextStatus="+t)}})},render:function(info_type,data){$("#"+info_type+" span").text(data.length);eval("PageBuilder.pop_"+info_type+"(data)");$.mobile.hidePageLoadingMsg();$("#timestamp").text($.prettyDate.format(update_time))},pop_jbxx:function(e){$("#dn_jbxx").remove();if(e.nsrMc)e=[e];var t='<div id="dn_jbxx" class="datanode gen"> <ul data-role="listview" data-inset="true">'+'<li data-role="list-divider">基本信息</li>'+"</ul></div>";$(".ui-content").append(t);var n=$("#dn_jbxx.gen>ul");$.each(e,function(e,t){var r="<li data-role='fieldcontain'><label for='name2'>纳税人名称：</label><span type='text'>"+t.nsrMc+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>纳税人编码：</label><span type='text'>"+t.nsrbm+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>注册地址：</label><span type='text'>"+t.zcDz+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>生产经营地址：</label><span type='text'>"+t.sjjyDz+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>注册类型：</label><span type='text'>"+t.zclx+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>所处街道：</label><span type='text'>"+t.xzjd+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>信誉等级：</label><span type='text'>"+t.xydjjb+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>法定代表人：</label><span type='text'>"+t.fddbrMc+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>联系电话：</label><span type='text'>"+t.lxdhDh+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>法人手机号码：</label><span type='text'>"+t.frsjhm+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>财务负责人：</label><span type='text'>"+t.cwfzrMc+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>办税员姓名：</label><span type='text'>"+t.bsyMc+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>控股类型：</label><span type='text'>"+t.kglx+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>税务登记：</label><span type='text'>"+t.swdjlb+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>税务登记证号：</label><span type='text'>"+t.swdjzh+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>登记状态：</label><span type='text'>"+t.djzt+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>隶属关系：</label><span type='text'>"+t.lsgx+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>行业：</label><span type='text'>"+t.hy+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>管理机关：</label><span type='text'>"+t.gljg+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>登记机关：</label><span type='text'>"+t.djjg+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>专管员：</label><span type='text'>"+t.zgy+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>税务登记日期：</label><span type='text'>"+t.djRq+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>工商开业时间：</label><span type='text'>"+t.yxQsrq+"</span></li>"+"<li data-role='fieldcontain'><label for='name2'>经营范围：</label><span type='text'>"+t.jyfwzy+"</span></li>"+"</fieldset></li>";n.append(r);$("#mytitle").text(t.nsrMc+"("+t.nsrbm+")")});n.listview({theme:"c"})},pop_hd:function(e){$("#dn_hd").remove();var t='<div id="dn_hd" class="datanode gen" style="display:none"> <ul data-role="listview" data-inset="true">'+'<li data-role="list-divider">核定信息</li>'+"</ul></div>";$(".ui-content").append(t);var n=$("#dn_hd.gen>ul");$.each(e,function(e,t){var r=t.id.hdQsrq;var i=' <li> <fieldset class="ui-grid-b ui-responsive"> '+"<li class='ui-block-a'><label>税    种：</label><span type='text'>"+t.id.sz+"</span>"+"<li class='ui-block-b'><label>品    目：</label><span type='text'>"+t.id.pm+"</span>"+"<li class='ui-block-c'><label>申报期限：</label><span type='text'>"+t.sbqx+"</span>"+"<li class='ui-block-a'><label>计税金额：</label><span type='text'>"+t.jsje+"</span><label>元</label>"+"<li class='ui-block-b'><label>税    率：</label><span type='text'>"+t.sl+"</span><label>%</label>"+"<li class='ui-block-c'><label>纳税期限：</label><span type='text'>"+t.nsqx+"</span>"+"<li class='ui-block-a'><label>速算扣除数：</label><span type='text'>"+t.sskcs+"</span>"+"<li class='ui-block-b'><label>应纳税额：</label><span type='text'>"+t.ynse+"</span>"+"<li class='ui-block-c'><label>征收方式：</label><span type='text'>"+t.zsfs+"</span>"+"<li class='ui-block-a'><label>计税依据：</label><span type='text'>"+t.jsyj+"</span>"+"<li class='ui-block-b'><label>起始日期：</label><span type='text'>"+r+"</span>"+"<li class='ui-block-c'><label>终止日期：</label><span type='text'>"+t.hdZzrq+"</span>"+"<li class='ui-block-a'><label>缴款名称：</label><span type='text'>"+t.jkmc+"</span>"+"</fieldset></li>";n.append(i)});n.listview({theme:"c"})},pop_sb:function(e){$("#dn_sb").remove();var t='<div id="dn_sb" class="mytitle datanode gen" style="display:none"> '+"申报情况"+"</div>";$(".ui-content").append(t);var n='<table data-role="table" id="t_sb" data-mode="columntoggle" class="ui-responsive table-stroke ui-body-d">'+'<thead><tr class="ui-bar-b">'+'<th data-priority="6">申报项目</th>'+'<th data-priority="1">税费所属期起</th>'+'<th data-priority="1" style="white-space:nowrap">税费所属期止</th>'+'<th data-priority="2">申报情况</th>'+'<th data-priority="2">申报状态 </th>'+"</tr></thead><tbody>";var r="";var i=new Date;var s=new Date;$.each(e,function(e,t){i=t.id.sfssqQsrq;s=t.id.sfssqZzrq;r=r+"<tr>"+"<th>"+t.id.zsxm+"</th>"+"<td>"+i+"</td>"+"<td>"+s+"</td>"+"<td>"+t.sbqk+"</td>"+"<td>"+t.sbzt+"</td>"+"</tr>"});var o="</tbody></table>";$("#dn_sb").append(n+r+o);$("#t_sb").table({columnBtnText:"显示列"})},pop_ns:function(e){$("#dn_ns").remove();var t='<div id="dn_ns" class="mytitle datanode gen" style="display:none"> '+"缴税情况"+"</div>";$(".ui-content").append(t);var n='<table data-role="table" id="t_ns" data-mode="columntoggle" class="ui-responsive table-stroke ui-body-d">'+'<thead><tr class="ui-bar-b">'+'<th data-priority="6">缴款期限</th>'+'<th data-priority="1">纳税人编码</th>'+'<th data-priority="1" style="white-space:nowrap">纳税人内部码</th>'+'<th data-priority="2">税费所属期起</th>'+'<th data-priority="2">税费所属期止</th>'+'<th data-priority="1">征收项目</th>'+'<th data-priority="3" width="120px">应征税费金额</th>'+"</tr></thead><tbody>";var r="";$.each(e,function(e,t){t=t.id;r=r+"<tr>"+"<th>"+t.jkQx+"</th>"+"<td>"+t.nsrbm+"</td>"+"<td>"+t.nsrnbm+"</td>"+"<td>"+t.sfssqQsrq+"</td>"+"<td>"+t.sfssqZzrq+"</td>"+"<td>"+t.sz+"</td>"+"<td>"+t.yzsfJe+"</td>"+"</tr>"});var i="</tbody></table>";$("#dn_ns").append(n+r+i);$("#t_ns").table({columnBtnText:"显示列"})},pop_fpgz:function(e){$("#dn_fpgz").remove();var t='<div id="dn_fpgz" class="mytitle datanode gen" style="display:none"> '+"发票购置情况"+"</div>";$(".ui-content").append(t);var n='<table data-role="table" id="t_fpgz" data-mode="columntoggle" class="ui-responsive table-stroke ui-body-d">'+'<thead><tr class="ui-bar-b">'+'<th data-priority="6">发票种类</th>'+'<th data-priority="1">发票批次</th>'+'<th data-priority="1" style="white-space:nowrap">计量单位</th>'+'<th data-priority="2">发票号码起</th>'+'<th data-priority="2">发票号码止</th>'+'<th data-priority="1">数量</th>'+'<th data-priority="3" width="120px">销售日期</th>'+"</tr></thead><tbody>";var r=new Date;var i="";$.each(e,function(e,t){r=t.xsRq;i=i+"<tr>"+"<th>"+t.id.fpzl+"</th>"+"<td>"+t.fppc+"</td>"+"<td>"+t.jldw+"</td>"+"<td>"+t.id.fpQshm+"</td>"+"<td>"+t.fpZzhm+"</td>"+"<td>"+t.sl+"</td>"+"<td>"+r+"</td>"+"</tr>"});var s="</tbody></table>";$("#dn_fpgz").append(n+i+s);$("#t_fpgz").table({columnBtnText:"显示列"})},pop_sbfjf:function(e){$("#dn_sbfjf").remove();var t='<div id="dn_sbfjf" class= "mytitle datanode gen" style="display:none"> '+"社保缴纳情况"+"</div>";$(".ui-content").append(t);var n='<table data-role="table" id="t_sbfjf" data-mode="columntoggle" class="ui-responsive table-stroke ui-body-d">'+'<thead><tr class="ui-bar-b">'+'<th data-priority="6">征收项目</th>'+'<th data-priority="1">征收品目</th>'+'<th data-priority="1" style="white-space:nowrap">申报方式</th>'+'<th data-priority="2">税款属性1</th>'+'<th data-priority="2">税款属性2</th>'+'<th data-priority="1">税费属性</th>'+'<th data-priority="3" width="120px">所属期</th>'+'<th data-priority="3">总金额</th>'+"</tr></thead><tbody>";var r="";$.each(e,function(e,t){t=t.id;r=r+"<tr>"+"<th>"+t.zsxm+"</th>"+"<td>"+t.zspm+"</td>"+"<td>"+t.sbfs+"</td>"+"<td>"+t.sksx1+"</td>"+"<td>"+t.sksx2+"</td>"+"<td>"+t.sfsx+"</td>"+"<td>"+t.ssq+"</td>"+"<td>"+t.sum+"</td>"+"</tr>"});var i="</tbody></table>";$("#dn_sbfjf").append(n+r+i);$("#t_sbfjf").table({columnBtnText:"显示列"})}}