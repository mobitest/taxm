<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>企业资料</title>
	<link rel="stylesheet"  href="../demos/css/themes/default/jquery.mobile-1.3.1.min.css">
	<link rel="stylesheet" href="../demos/_assets/css/jqm-demos.css">
	<link rel="shortcut icon" href="../demos/favicon.ico">

	<link rel="stylesheet" href="t1-welcome.css">
	<link rel="stylesheet" href="info.css">
	
	<style>
		#d5.mytitle{
		position: relative;
		top: 25px;
		left: 10px;
		border-bottom: 2px solid #08c;
		float: left;
		font-weight: 800;
		font-size: 18px;
		}
	</style>
	
	<script src="../demos/js/jquery.js"></script>
	<script src="../demos/_assets/js/index.js"></script>
	<script src="../demos/js/jquery.mobile-1.3.1.min.js"></script>
	<script src="../demos/js/taxm.js"></script>	

<!--
        		["d1"/*	基本资料*/	:"TNsrjbxx"   ,	
            "d2"/*	核定信息*/	:"TNsrhdqk"   ,
            "d3"/*	申报情况*/	:"TNsrsbqk"   ,
            "d4"/*	缴税情况*/	:"TNsrnsqk"   ,
            "d5"/*	发票购置*/	:"TNsrfpgzqk" ,
            "d6"/*	社保缴纳*/	:"TSbfjfqk"   ],
-->
	
	<script>

		$(document).ready(function(){
			
			//动态生成页面
			PageBuilder.dynamicLoad("ns",qs("id"));
		});
		
		var dbutil = dbutil.init();
		dbutil.createTable();
		function qs(key) {
		    key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
		    var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
		    return match && decodeURIComponent(match[1].replace(/\+/g, " "));
		}	
		//入口：取数据，并调用页面生成器，生成页面

				/*页面生成器 BY takeashower*/
			PageBuilder={
				/*
				dynamicLoad flow:
			//1先从本地取，调页面生成4
			//2本地没有，联网取getRemote;联网取到后，写本地，并调页面生成4
			//3生成页面 do
				
				getLocal	从本地取数；
				info_type:信息类型（ns纳税、hd核定、jbxx基本信息、sb申报、sbfjf社保、fpgz发票购置）
				id:标识值
				*/
				dynamicLoad:function(info_type, id){
					dbutil.findByName("corp_"+ info_type, id, function(tx, r){
						//a 本地无数据
						if(r.rows.length ==0 || r.rows.item(0).content.length <3){
							PageBuilder.getRemote(info_type, id, SERVER +  SERVICE_PATH + info_type +"/" + id + ".json");
							return;
						}
						//b 本地有数据
						PageBuilder.do(info_type, JSON.parse(r.rows.item(0).content));
					});

				},
				/*
				getRemote联网取数
				info_type:信息类型（ns纳税、hd核定、jbxx基本信息、sb申报、sbfjf社保、fpgz发票购置）
				id: 标识值
				path:路径 ，如/services/api/ns/
				*/
				getRemote:function(info_type, id, path){
					$.ajax({url: path,					
							dataType:"jsonp",
							success:function(entry){
								//缓存数据
								var o = new Object();
								o.name = id; o.content = JSON.stringify(entry);
								dbutil.writeRow("corp_"+ info_type, o, function(tx, r){console.log("write a row, name=" + id);} );
								PageBuilder.do(info_type, entry);
							
							},
							error: function(XMLHttpRequest, textStatus, errorThrown){ 
		            alert('error:'+errorThrown); 
		       		}
	
						});
					
				},
				do:function(info_type, data){
							//获取值，调用子页生成函数
							if(info_type == "ns") PageBuilder.d5pop(data);
							
							
							
				},
				d5pop:function(d){
       	   var head= '<div id="d5" class="mytitle"> '+
       	   '缴税情况'+
       	   '</div>';
       	  
       	   $('.ui-content').append(head);
       	   var lv = $("#table_li");
						var tb_1=
						'<table data-role="table" id="table-column-toggle" data-mode="columntoggle" class="ui-responsive table-stroke ui-body-d">'+
     				'<thead><tr class="ui-bar-b">'+
         		'<th data-priority="6">缴款期限</th>'+
         		'<th data-priority="1">纳税人编码</th>'+
         		'<th data-priority="1" style="white-space:nowrap">纳税人内部码</th>'+
         		'<th data-priority="2">税费所属期起</th>'+
         		'<th data-priority="2">税费所属期止</th>'+
         		'<th data-priority="1">征收项目</th>'+
         		'<th data-priority="3" width="120px">应征税费金额</th>'+
       			'</tr></thead><tbody>' ;
       			
       			//$('.ui-content').append(tb_1);	
       		var tb_2=	""	
					//遍历该节点下的记录
					$.each(d,function(i, entry){
						 //处理单条发票购置记录的生成
						 entry = entry.id;

						tb_2=	tb_2 +
       		 	'<tr>'+
         		'<th>'+ entry.jkQx +'</th>'+
         		'<td>'+ entry.nsrbm +'</td>'+
         		'<td>'+ entry.nsrnbm +'</td>'+
         		'<td>'+ entry.sfssqQsrq +'</td>'+
         		'<td>'+ entry.sfssqZzrq +'</td>'+
         		'<td>'+ entry.sz +'</td>' +
         		'<td>'+ entry.yzsfJe +'</td>'+         		         		
       			'</tr>';

						//$('.ui-content').append(tb_2);    
						//lv.append(tb_2);

					});//-- each

					var tb_3="</tbody></table>";
					//一次性添加内容（每添加一次都是对象，而非字符串，所以元素位置会错乱；同时注意性能
					$('.ui-content').append(tb_1 + tb_2 + tb_3);	

					//初始化表格，设按钮文字
					$("#table-column-toggle").table({ columnBtnText: "显示列" });
					//$('#d5>ul').listview();
					
				}
				
			};
	
		
	</script>
</head>
<body>
<div data-role="page" data-theme="c" id="demo-page" class="my-page2">

	<div data-role="header" data-position="fixed" data-tap-toggle="false"> 


		<div data-role="controlgroup" data-type="horizontal">
			<a href="t1-welcome.htm?user=someone" data-role="button" data-icon="logo-taxm" data-iconpos="notext" data-ajax="false">主屏</a>
				<a href="t2-search.htm" data-role="button"  data-ajax="false">一户式查询
        <a href="#left-panel" data-role="button" data-ajax="false" data-icon="bars" data-iconpos="notext">选项</a>

		</div>
		<h1 id="mytitle">演示页（web服务器中才能正常浏览）</h1>
	<a href="javascript:alert('your device is offline...please check it out!')" rel="external" class="ui-btn-right" data-shadow="false" data-iconshadow="false" data-icon="grid" data-iconpos="right" data-ajax="false">联网更新</a>

	</div><!-- /header -->
	

<div data-role="content">
<p id="info">
	<a href="#" data-role="button" data-icon="info" data-iconpos="notext" data-theme="c" data-inline="true">Info</a>
	数据更新：
	<span>2012-01-01 14:00</span>
</p>

              
</div><!-- /content -->
    

</div><!-- /page -->
</body>
</html>
 